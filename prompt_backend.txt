# Role: Senior Backend Developer
# Task: Implement backend components for Issue #6: [Infrastructure] Persistence Layer: LocalStorage System for Progress Tracking Use Go/Python. Implement API endpoints and business logic.

Please write the code for the following requirements.

## Context
Project: TheMiddleWay-Root
Issue: #6 [Infrastructure] Persistence Layer: LocalStorage System for Progress Tracking
Body:
No details provided.

## Architecture & Plans (AUTHORITATIVE)
The following content is from the approved design documents. **You MUST follow this design.**


## Reference: analysis.md
# Analysis Template

> ðŸ“‹ Template à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸à¹ˆà¸­à¸™à¹€à¸£à¸´à¹ˆà¸¡à¸žà¸±à¸’à¸™à¸² Feature

---

## ðŸ“Œ Feature Information

| à¸£à¸²à¸¢à¸à¸²à¸£ | à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸” |
|--------|-----------|
| **Feature Name** | Persistence Layer: LocalStorage System for Progress Tracking |
| **Issue URL** | [#6](https://github.com/owner/repo/issues/6) |
| **Date** | 2023-10-27 |
| **Analyst** | Luma AI (Senior Technical Analyst) |
| **Priority** | ðŸ”´ High |
| **Status** | ðŸ“ Draft |

---

## 1. Requirement Analysis

### 1.1 Problem Statement

> à¸­à¸˜à¸´à¸šà¸²à¸¢à¸›à¸±à¸à¸«à¸²à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹à¸à¹‰à¹„à¸‚

```
The application currently lacks a mechanism to save user progress on their local device. When a user closes the application or browser tab, all progress (e.g., completed lessons, quiz attempts, current location in a course) is lost. This forces users to start over from the beginning in each new session, leading to a frustrating and disjointed user experience.
```

### 1.2 User Stories

| # | As a | I want to | So that |
|---|------|-----------|---------|
| 1 | User | have my progress automatically saved on my device | I can close the app and resume where I left off later without losing my work. |
| 2 | Developer | have a simple, standardized API to save and retrieve user progress data | I can easily implement progress tracking across different features consistently. |

### 1.3 Acceptance Criteria

- [ ] **AC1:** A persistence service/module is created that uses the platform's native local storage (`LocalStorage` for Web, `SharedPreferences` for Android, `UserDefaults` for iOS).
- [ ] **AC2:** The service must expose clear methods to `save`, `load`, and `clear` progress data.
- [ ] **AC3:** When the application starts, it must attempt to load any existing progress data and restore the application state accordingly.
- [ ] **AC4:** If no progress data is found (e.g., a first-time user), the application should start in a default, clean state without errors.
- [ ] **AC5:** User actions that constitute "progress" (e.g., completing a module, answering a question) must trigger the `save` method to update the local storage.

---

## 2. Feature Analysis

### 2.1 User Flow

```mermaid
flowchart TD
    subgraph App Initialization
        A[App Starts] --> B{Check Local Storage for Progress Data};
        B -->|Data Found| C[Parse Data];
        C --> D[Restore Application State];
        B -->|No Data Found / Error| E[Initialize Default State];
    end

    subgraph User Interaction
        F[User performs an action, e.g., completes a lesson] --> G[Application state changes];
        G --> H[Call PersistenceService.save(newState)];
        H --> I[Serialize state to JSON];
        I --> J[Write JSON to Local Storage];
    end

    D --> F
    E --> F
```

### 2.2 Screen/Page Requirements

| à¸«à¸™à¹‰à¸²à¸ˆà¸­ | Actions | Components |
|--------|---------|------------|
| N/A (Infrastructure) | This is a background service, not a user-facing screen. It will be integrated into all screens that manage user progress. | - **PersistenceService:** A new module/class for handling storage operations. <br/> - **State Management Integration:** Connects the service to the app's state manager (e.g., Redux, Zustand, Context API). |

### 2.3 Input/Output Specification

#### Inputs

| Field | Type | Required | Validation |
|-------|------|----------|------------|
| progressObject | object | âœ… | Must be a serializable object (JSON). A schema should be defined to ensure consistency. |

#### Outputs

| Field | Type | Description |
|-------|------|-------------|
| loadedProgressObject | object / null | The deserialized progress object retrieved from storage, or `null` if no data was found. |
| success | boolean | A boolean flag returned by `save` and `clear` operations indicating success or failure. |

---

## 3. Impact Analysis

### 3.1 Affected Components

| Component | Impact Level | Description |
|-----------|--------------|-------------|
| **Web Client (React/Next.js)** | ðŸ”´ High | A new service or hook (e.g., `useProgressTracker`) will be created to interact with `LocalStorage`. This will need to be integrated into the main state management logic and various feature components. |
| **Android Client (Kotlin)** | ðŸ”´ High | A new repository or manager class (e.g., `ProgressRepository`) will be created to manage data in `SharedPreferences`. This will impact ViewModels and state holders across the app. |
| **iOS Client (Swift)** | ðŸ”´ High | A new service class (e.g., `PersistenceService`) will be created to manage data in `UserDefaults`. This will need to be integrated with SwiftUI views and data models. |
| **Backend (Python/Go)** | ðŸŸ¢ Low | No direct impact. This feature is entirely client-side. However, the data schema should be designed with future backend synchronization in mind. |
| **State Management** | ðŸ”´ High | The core state management system must be modified to initialize its state from the persistence layer on startup and to trigger saves upon state changes. |

### 3.2 Breaking Changes

- [ ] **BC1:** No breaking changes are 
(truncated if too long)


## Reference: plan.md
# Implementation Plan: LocalStorage Persistence for Progress Tracking

> **Refers to**: [#6 LocalStorage Persistence for Progress Tracking](https://github.com/mdwmediaworld072/TheMiddleWay/issues/6)
> **Status**: Draft

## 1. Architecture & Design
The implementation will be encapsulated within a dedicated `PersistenceService` module. This service will act as the sole interface for all `LocalStorage` operations related to user progress, abstracting the underlying mechanism from the rest of the application. This approach promotes separation of concerns, simplifies testing, and makes it easier to swap out the persistence layer in the future if needed (e.g., to a backend API).

The service will handle serialization (object to JSON string), deserialization (JSON string to object), and error handling (e.g., `LocalStorage` being unavailable, corrupt data). Application components will interact with this service to save, load, or reset progress data, updating the application's state accordingly.

### Component View
- **Modified Components**:
    - `ApplicationRoot`: The main application component will be modified to call `PersistenceService.loadProgress()` on initial load to restore the user's state.
    - `LessonComponent` (or similar): Components responsible for user progress checkpoints (e.g., lesson completion) will be modified to call `PersistenceService.saveProgress()` with the updated state.
    - `SettingsComponent`: A component (likely new or existing) will contain the UI for resetting progress and will call `PersistenceService.resetProgress()`.
- **New Components**:
    - `src/services/persistenceService.ts`: A new TypeScript module that encapsulates all `LocalStorage` logic.
- **Dependencies**:
    - None. This implementation will use the native Web `LocalStorage` API, which requires no external libraries.

### Data Model Changes
We will define a TypeScript interface to ensure type safety for the progress data being stored.

```typescript
// src/types/progress.ts

/**
 * Defines the structure for user progress data stored in LocalStorage.
 * @property version - Schema version for future data migrations.
 * @property completedLessons - An array of unique identifiers for each completed lesson.
 */
export interface UserProgress {
  version: number;
  completedLessons: string[];
  // Future properties like quizScores, etc., can be added here.
}
```

---

## 2. Step-by-Step Implementation

### Step 1: Create the Persistence Service Module
This step establishes the foundation of our persistence layer with a clear API.

- **Files**:
    - Create `src/services/persistenceService.ts`
    - Create `src/types/progress.ts` (as defined in the Data Model section)
- **Code**:
    - Define a constant for the `LocalStorage` key: `const STORAGE_KEY = 'theMiddleWay.progress';`.
    - Create and export three functions:
        - `saveProgress(progress: UserProgress): void`
        - `loadProgress(): UserProgress | null`
        - `resetProgress(): void`
    - Implement basic error handling to check if `localStorage` is available. If not, the functions should fail gracefully (e.g., log a warning and do nothing).

- **Verification**:
    - The file `src/services/persistenceService.ts` exists.
    - The three core functions are exported.
    - The code compiles without type errors.

### Step 2: Implement `saveProgress` and `loadProgress` Logic
This step implements the core read/write functionality.

- **Files**:
    - Modify `src/services/persistenceService.ts`
- **Code**:
    - **`saveProgress`**:
        - Inside a `try...catch` block:
        - Serialize the incoming `UserProgress` object to a JSON string using `JSON.stringify()`.
        - Call `localStorage.setItem(STORAGE_KEY, serializedData)`.
        - Catch potential errors (e.g., storage quota exceeded) and log them.
    - **`loadProgress`**:
        - Inside a `try...catch` block:
        - Call `localStorage.getItem(STORAGE_KEY)`.
        - If the result is `null`, return `null` (no saved data).
        - If data exists, parse it using `JSON.parse()`.
        - Return the parsed `UserProgress` object.
        - The `catch` block should handle JSON parsing errors (corrupt data). In case of an error, log it and return `null`, fulfilling requirement **FR-7**.
- **Verification**:
    - Unit tests will be written to verify this logic (see Verification Plan).
    - Manually call `saveProgress` from the browser console with a sample object and verify the correct JSON string is stored in `LocalStorage` via DevTools.
    - Manually call `loadProgress` and verify it returns the correct object.
    - Manually set a malformed string in `LocalStorage` and verify `loadProgress` returns `null` without crashing.

### Step 3: Implement `resetProgress` Logic
This step implements the data removal functionality.

- **Files**:
    - Modify `src/services/persistenceService.ts`
- **Code**:
    - **`resetProgress`**:
        - Inside a `try...catch` block:
        - Call `localStorage.remo
(truncated if too long)


## Reference: spec.md
```markdown
# Specification: LocalStorage Persistence for Progress Tracking

| | |
| --- | --- |
| **Title** | [Infrastructure] Persistence Layer: LocalStorage System for Progress Tracking |
| **Issue URL** | [#6](https://github.com/mdwmediaworld072/TheMiddleWay/issues/6) |
| **Status** | **Draft** |
| **Author** | Expert Product Manager |
| **Last Updated** | 2023-10-27 |

---

### 1. Overview

This document specifies the requirements for a client-side persistence layer using the browser's `LocalStorage` API. The primary purpose of this system is to automatically save and retrieve a user's progress within "The Middle Way" application. This ensures that users can close their browser or refresh the page and seamlessly resume their journey from their last completed step, enhancing user retention and satisfaction. This system is designed for a single-device, single-browser experience and does not include server-side synchronization.

### 2. Goal

As a user of "The Middle Way", I want my progress to be saved automatically in my browser so that I can close the application at any time and resume exactly where I left off when I return, without losing my work. This provides a sense of continuity and encourages me to continue my journey.

### 3. User Stories

| ID | User Story |
| :--- | :--- |
| **US-1** | As a user, I want my progress (e.g., completed lessons, modules) to be saved automatically at key checkpoints so that I don't have to manually save my work. |
| **US-2** | As a returning user, I want the application to automatically load my saved progress so that the UI reflects my completed steps and I can easily see where to continue. |
| **US-3** | As a first-time user, I want the application to start from the beginning, as there is no prior progress to load. |
| **US-4** | As a user, I want the ability to reset all my progress so that I can start the entire journey over from the beginning if I choose to. |

### 4. Functional Requirements

| ID | Requirement Description |
| :--- | :--- |
| **FR-1** | **Save Progress**: The system MUST save the user's progress data to the browser's `LocalStorage` under a designated key (e.g., `theMiddleWay.progress`). |
| **FR-2** | **Data Format**: The progress data MUST be stored in a structured, extensible format, such as JSON. |
| **FR-3** | **Trigger for Saving**: The system MUST automatically save progress upon the completion of a significant user action (e.g., finishing a lesson, completing a quiz). |
| **FR-4** | **Load Progress**: On application load, the system MUST attempt to read progress data from `LocalStorage`. |
| **FR-5** | **State Restoration**: If progress data is found and is valid, the application's state and UI MUST be updated to reflect this saved progress. |
| **FR-6** | **Handle No Data**: If no progress data is found in `LocalStorage` (e.g., first visit, cleared cache), the application MUST start from a default, clean state (i.e., no progress). |
| **FR-7** | **Handle Corrupt Data**: If the data retrieved from `LocalStorage` is malformed or invalid, the system MUST treat it as if no data was found and start from a clean state. |
| **FR-8** | **Reset Progress**: The system MUST provide a mechanism to completely remove the progress data from `LocalStorage`, effectively resetting the user's state to the beginning. |

### 5. Non-Functional Requirements

| ID | Requirement Description |
| :--- | :--- |
| **NFR-1** | **Performance**: `LocalStorage` read/write operations must be non-blocking and have no perceivable impact on the user interface's responsiveness. |
| **NFR-2** | **Data Scope**: The system will only store non-sensitive progress data. No Personally Identifiable Information (PII) or credentials will be stored. |
| **NFR-3** | **Browser Support**: The solution must be compatible with all modern browsers that support the `LocalStorage` Web API (Chrome, Firefox, Safari, Edge). |
| **NFR-4** | **Reliability**: The system should gracefully handle cases where `LocalStorage` is disabled or unavailable in the user's browser, defaulting to a non-persistent session. |

### 6. User Journey

1.  **First-Time Visit**:
    *   Alex opens "The Middle Way" application for the first time.
    *   The system checks `LocalStorage` and finds no progress data.
    *   The application presents the very beginning of the journey to Alex (e.g., "Introduction").
    *   Alex completes the "Introduction" and "Lesson 1". After completing "Lesson 1", the system silently saves this progress to `LocalStorage`.
    *   Alex closes the browser tab.

2.  **Returning Visit**:
    *   A day later, Alex re-opens the application in the same browser.
    *   The system checks `LocalStorage`, finds the saved progress data, and parses it.
    *   The application loads and the UI immediately shows that the "Introduction" and "Lesson 1" are marked as complete.
    *   The application directs Alex to the start of "Lesson 2", allowing them to seamlessly continue.

3.  **Resetting Progress**:
(truncated if too long)


## Default Guidance (Use only if not specified in Plans)
- Tech Stack: Go/Python. Implement API endpoints and business logic.
- Follow Clean Architecture
- Ensure TDD (Test Driven Development)

**IMPORTANT CONFLICT RESOLUTION:**
If the 'Architecture & Plans' section conflicts with the 'Default Guidance', **FOLLOW THE PLANS**.

## Output Format
Please provide the full code files wrapped in XML tags:
<file path="path/to/file.ext">
... code ...
</file>

## Language
Please explain your solution and comments in Thai only.
