# Role: Senior iOS Developer
# Task: Implement iOS persistence layer for Issue #15: [Infrastructure] Persistence Layer
# Platform: Swift + SwiftUI + @AppStorage / UserDefaults
# Issue: https://github.com/oatrice/TheMiddleWay-Metadata/issues/15

## Context
Project: The Middle Way (‡∏ó‡∏≤‡∏á‡∏™‡∏≤‡∏¢‡∏Å‡∏•‡∏≤‡∏á)
Feature: Client-side persistence to save user progress using iOS UserDefaults / @AppStorage.
This is a **client-side only** feature ‚Äî no backend required.

## Architecture & Plans (AUTHORITATIVE)
The following approved design documents define the implementation. **You MUST follow this design.**

üìÇ **Full Documents Path:**
- `docs/features/4_issue-6_infrastructure-persistence-layer-localstorage-system-for-progress-tracking/spec.md`
- `docs/features/4_issue-6_infrastructure-persistence-layer-localstorage-system-for-progress-tracking/plan.md`
- `docs/features/4_issue-6_infrastructure-persistence-layer-localstorage-system-for-progress-tracking/analysis.md`
- `docs/features/4_issue-6_infrastructure-persistence-layer-localstorage-system-for-progress-tracking/specs/sbe_issue-6.md`

---

## iOS-Specific Implementation Plan

### Tech Stack
- **Language:** Swift 5.9+
- **UI:** SwiftUI
- **Storage API:** `UserDefaults` for complex data, `@AppStorage` for simple preferences
- **Serialization:** `Codable` (JSONEncoder/JSONDecoder)
- **Architecture:** MVVM
- **Testing:** XCTest

### Data Schema (v1)
```swift
// Core/Models/UserProgress.swift
struct UserProgress: Codable, Equatable {
    var version: Int = 1
    var themeMode: String = "light"  // "light" | "dark"
    var language: String = "th"      // "th" | "en"
    var completedLessons: [String] = []
    var bookmarks: [String] = []
    var lastVisited: String = ""     // ISO 8601 datetime

    static let `default` = UserProgress()
}
```

### Files to Create/Modify
| File | Action | Description |
|------|--------|-------------|
| `Core/Models/UserProgress.swift` | Create | Codable struct for persistence |
| `Core/Services/PersistenceService.swift` | Create | Protocol + UserDefaults implementation |
| `Core/Services/PersistenceServiceTests.swift` | Create | Unit tests (TDD ‚Äî write tests FIRST) |
| `Core/Theme/ThemeManager.swift` | Modify | Integrate with persistence (theme already exists) |

### UserDefaults Key
```swift
static let storageKey = "theMiddleWay.progress"
```

### API Contract
```swift
protocol PersistenceServiceProtocol {
    func saveProgress(_ progress: UserProgress) -> Bool
    func loadProgress() -> UserProgress?
    func clearProgress() -> Bool
}

class PersistenceService: PersistenceServiceProtocol {
    private let defaults: UserDefaults
    
    init(defaults: UserDefaults = .standard) {
        self.defaults = defaults
    }
    // ...
}
```

### Error Handling
- Encoding failure ‚Üí catch `EncodingError`, log warning, return `false`
- Decoding failure ‚Üí catch `DecodingError`, log warning, return `nil`, use default state
- UserDefaults unavailable ‚Üí very rare on iOS, but handle gracefully

### Integration with Existing Theme
```swift
// ThemeManager.swift ‡πÉ‡∏ä‡πâ @AppStorage ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö themeMode ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (#13)
// ‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡πÉ‡∏ä‡πâ PersistenceService ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
```

### Acceptance Criteria
- [ ] AC1: `PersistenceService` created with save/load/clear methods
- [ ] AC2: Unit tests pass (TDD ‚Äî tests written first) using XCTest
- [ ] AC3: App loads saved data on startup and restores state
- [ ] AC4: First-time users get clean default state (no errors)
- [ ] AC5: Theme preference persists across sessions (integrate with existing #13)
- [ ] AC6: Data uses versioned Codable schema (v1)
- [ ] AC7: `PersistenceService` is injectable (protocol-based) for testability

---

## TDD Mode (REQUIRED)
Follow strict TDD cycle:
1. üü• RED: Write failing test first
2. üü¢ GREEN: Write simplest code to pass
3. ‚ú® REFACTOR: Clean up, ensure all tests pass

## Output Format
Please provide the full code files wrapped in XML tags:
<file path="path/to/file.ext">
... code ...
</file>

## Language
Please explain your solution and comments in Thai only.
