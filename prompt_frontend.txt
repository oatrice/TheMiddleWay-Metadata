# Role: Senior Frontend Developer (Web)
# Task: Implement Web persistence layer for Issue #15: [Infrastructure] Persistence Layer
# Platform: Next.js + TypeScript
# Issue: https://github.com/oatrice/TheMiddleWay-Metadata/issues/15

## Context
Project: The Middle Way (‡∏ó‡∏≤‡∏á‡∏™‡∏≤‡∏¢‡∏Å‡∏•‡∏≤‡∏á)
Feature: Client-side persistence to save user progress using browser `localStorage`.
This is a **client-side only** feature ‚Äî no backend required.

## Architecture & Plans (AUTHORITATIVE)
The following approved design documents define the implementation. **You MUST follow this design.**

üìÇ **Full Documents Path:**
- `docs/features/4_issue-6_infrastructure-persistence-layer-localstorage-system-for-progress-tracking/spec.md`
- `docs/features/4_issue-6_infrastructure-persistence-layer-localstorage-system-for-progress-tracking/plan.md`
- `docs/features/4_issue-6_infrastructure-persistence-layer-localstorage-system-for-progress-tracking/analysis.md`
- `docs/features/4_issue-6_infrastructure-persistence-layer-localstorage-system-for-progress-tracking/specs/sbe_issue-6.md`

---

## Web-Specific Implementation Plan

### Tech Stack
- **Framework:** Next.js 16 (App Router)
- **Language:** TypeScript
- **Storage API:** `window.localStorage`
- **State Management:** React Context + useReducer
- **Testing:** Jest or Vitest

### Data Schema (v1)
```typescript
// lib/types/progress.ts
export interface UserProgress {
  version: 1;
  themeMode: 'light' | 'dark';
  language: 'th' | 'en';
  completedLessons: string[];
  bookmarks: string[];
  lastVisited: string; // ISO 8601 datetime
}

export const DEFAULT_PROGRESS: UserProgress = {
  version: 1,
  themeMode: 'light',
  language: 'th',
  completedLessons: [],
  bookmarks: [],
  lastVisited: new Date().toISOString(),
};
```

### Files to Create/Modify
| File | Action | Description |
|------|--------|-------------|
| `lib/types/progress.ts` | Create | TypeScript interface for `UserProgress` |
| `lib/services/persistenceService.ts` | Create | Core service: `save()`, `load()`, `clear()` |
| `lib/services/__tests__/persistenceService.test.ts` | Create | Unit tests (TDD ‚Äî write tests FIRST) |
| `app/layout.tsx` | Modify | Load progress on app startup |
| `hooks/useTheme.ts` | Modify | Integrate with persistence (theme already exists) |

### Storage Key
```
const STORAGE_KEY = 'theMiddleWay.progress';
```

### API Contract
```typescript
export function saveProgress(progress: UserProgress): boolean;
export function loadProgress(): UserProgress | null;
export function clearProgress(): boolean;
```

### Error Handling
- `localStorage` unavailable ‚Üí fail gracefully, log warning, operate session-only
- Corrupt/malformed JSON ‚Üí return `null`, log warning, use default state
- Storage quota exceeded ‚Üí catch error, log, return `false`

### Acceptance Criteria
- [ ] AC1: `persistenceService.ts` created with `save/load/clear` methods
- [ ] AC2: Unit tests pass (TDD ‚Äî tests written first)
- [ ] AC3: App loads saved data on startup and restores state
- [ ] AC4: First-time users get clean default state (no errors)
- [ ] AC5: Theme preference persists across sessions (already done in #13, integrate)
- [ ] AC6: Data uses versioned JSON schema (v1)

---

## TDD Mode (REQUIRED)
Follow strict TDD cycle:
1. üü• RED: Write failing test first
2. üü¢ GREEN: Write simplest code to pass
3. ‚ú® REFACTOR: Clean up, ensure all tests pass

## Output Format
Please provide the full code files wrapped in XML tags:
<file path="path/to/file.ext">
... code ...
</file>

## Language
Please explain your solution and comments in Thai only.
