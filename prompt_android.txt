# Role: Senior Android Developer
# Task: Implement Android persistence layer for Issue #15: [Infrastructure] Persistence Layer
# Platform: Kotlin + Jetpack Compose + DataStore Preferences
# Issue: https://github.com/oatrice/TheMiddleWay-Metadata/issues/15

## Context
Project: The Middle Way (‡∏ó‡∏≤‡∏á‡∏™‡∏≤‡∏¢‡∏Å‡∏•‡∏≤‡∏á)
Feature: Client-side persistence to save user progress using Android DataStore Preferences.
This is a **client-side only** feature ‚Äî no backend required.

## Architecture & Plans (AUTHORITATIVE)
The following approved design documents define the implementation. **You MUST follow this design.**

üìÇ **Full Documents Path:**
- `docs/features/4_issue-6_infrastructure-persistence-layer-localstorage-system-for-progress-tracking/spec.md`
- `docs/features/4_issue-6_infrastructure-persistence-layer-localstorage-system-for-progress-tracking/plan.md`
- `docs/features/4_issue-6_infrastructure-persistence-layer-localstorage-system-for-progress-tracking/analysis.md`
- `docs/features/4_issue-6_infrastructure-persistence-layer-localstorage-system-for-progress-tracking/specs/sbe_issue-6.md`

---

## Android-Specific Implementation Plan

### Tech Stack
- **Language:** Kotlin
- **UI:** Jetpack Compose
- **Storage API:** DataStore Preferences (NOT SharedPreferences)
- **Serialization:** Kotlinx Serialization (JSON)
- **Architecture:** MVVM + Repository Pattern
- **DI:** Hilt or Manual
- **Testing:** JUnit 5 + MockK

### Data Schema (v1)
```kotlin
// data/model/UserProgress.kt
@Serializable
data class UserProgress(
    val version: Int = 1,
    val themeMode: String = "light",  // "light" | "dark"
    val language: String = "th",      // "th" | "en"
    val completedLessons: List<String> = emptyList(),
    val bookmarks: List<String> = emptyList(),
    val lastVisited: String = "" // ISO 8601 datetime
)
```

### Files to Create/Modify
| File | Action | Description |
|------|--------|-------------|
| `data/model/UserProgress.kt` | Create | Data class for persistence |
| `data/repository/PersistenceRepository.kt` | Create | Interface for persistence operations |
| `data/repository/PersistenceRepositoryImpl.kt` | Create | DataStore implementation |
| `data/repository/PersistenceRepositoryTest.kt` | Create | Unit tests (TDD ‚Äî write tests FIRST) |
| `ui/theme/ThemeViewModel.kt` | Modify | Integrate with persistence |

### DataStore Key
```kotlin
val PROGRESS_KEY = stringPreferencesKey("theMiddleWay.progress")
```

### API Contract
```kotlin
interface PersistenceRepository {
    suspend fun saveProgress(progress: UserProgress): Boolean
    suspend fun loadProgress(): UserProgress?
    suspend fun clearProgress(): Boolean
    fun observeProgress(): Flow<UserProgress?>
}
```

### Error Handling
- DataStore unavailable ‚Üí catch IOException, return default
- Corrupt JSON ‚Üí catch SerializationException, return null, log warning
- All operations are `suspend` ‚Äî never block main thread

### Acceptance Criteria
- [ ] AC1: `PersistenceRepository` created with save/load/clear + Flow
- [ ] AC2: Unit tests pass (TDD ‚Äî tests written first)
- [ ] AC3: App loads saved data on startup and restores state
- [ ] AC4: First-time users get clean default state (no errors)
- [ ] AC5: Theme preference persists across sessions
- [ ] AC6: Data uses versioned JSON schema (v1)
- [ ] AC7: All I/O runs on background thread (Dispatchers.IO)

### IMPORTANT
- Do NOT use `./gradlew` directly. You MUST use scripts in `./Android/scripts/` (e.g., `./Android/scripts/run_tests.sh`, `./Android/scripts/build.sh`)

---

## TDD Mode (REQUIRED)
Follow strict TDD cycle:
1. üü• RED: Write failing test first
2. üü¢ GREEN: Write simplest code to pass
3. ‚ú® REFACTOR: Clean up, ensure all tests pass

## Output Format
Please provide the full code files wrapped in XML tags:
<file path="path/to/file.ext">
... code ...
</file>

## Language
Please explain your solution and comments in Thai only.
